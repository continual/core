package io.continual.iam.impl.common.jwt;

import java.security.NoSuchAlgorithmException;
import java.security.cert.CertificateException;
import java.security.spec.InvalidKeySpecException;

import org.json.JSONObject;
import org.junit.Test;

import io.continual.iam.credentials.JwtCredential;
import io.continual.iam.credentials.JwtCredential.InvalidJwtToken;
import io.continual.iam.impl.common.jwt.SimpleJwtValidator.RsaValidator;
import junit.framework.TestCase;

public class JwtRsaTest extends TestCase
{
	@Test
	public void testJwtWithRsa () throws NoSuchAlgorithmException, InvalidKeySpecException, InvalidJwtToken
	{
		final RsaValidator v = new RsaValidator ( new JSONObject ()
			.put ( "e", "AQAB" )
			.put ( "n", "0QW_fsq8WFtNPeOp8cJO1zoToB_E2HBs1Y4ceJB_3qgJmATBCffGwTm7waYEgIlQbJ7fqP1ttgdab-5yQTDGrE51_KS1_3jlB_EDYZPciT3uzHo69BE0v4h9A29fG2MTR1iwkjqDuWE-JN1TNQUeYZ554WYktX1d0qnaiOhM8jNLcuU948LW9d-9xwd7NwnKD_PakCOWRUqXZVYnS7EsTMG4aZpZk0ZB-695tsH-NmwqISPfXI7sEjINRd2PdD9mvs2xAfp-T7eaCV-C3fTfoHDGB3Vwkfn1rG2p-hFB57vzUYB8vEdRgR8ehhEgWndLU6fovvVToWFnPcvkm-ZFxw" )
		);

		final JwtCredential cred = new JwtCredential ( "eyJhbGciOiJSUzI1NiIsImtpZCI6IjA1YTAyNjQ5YTViNDVjOTBmZGZlNGRhMWViZWZhOWMwNzlhYjU5M2UiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJhY2NvdW50cy5nb29nbGUuY29tIiwiYXpwIjoiMTA4OTEzNzA1NTkxOS1yamlvYjRpZjdscjd2c3R2NGlidjM1YnJ2cWM4dHFuZy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6IjEwODkxMzcwNTU5MTktcmppb2I0aWY3bHI3dnN0djRpYnYzNWJydnFjOHRxbmcuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJzdWIiOiIxMDIzNzUwNDQwNzE0NjkwNDkwMDEiLCJoZCI6InJhdGhyYXZhbmUuY29tIiwiZW1haWwiOiJwZXRlckByYXRocmF2YW5lLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhdF9oYXNoIjoiNlpvSEdyNlVKMDN1X19jMUpfaXg1ZyIsIm5hbWUiOiJQZXRlciBDYXJkb25hIiwicGljdHVyZSI6Imh0dHBzOi8vbGg0Lmdvb2dsZXVzZXJjb250ZW50LmNvbS8tS3RrNjY1cThxRjAvQUFBQUFBQUFBQUkvQUFBQUFBQUFBQUEvQUNIaTNyZVpwVlMzeUs2cTlkWVdBZmhRNFJFNHpCSnFoQS9zOTYtYy9waG90by5qcGciLCJnaXZlbl9uYW1lIjoiUGV0ZXIiLCJmYW1pbHlfbmFtZSI6IkNhcmRvbmEiLCJsb2NhbGUiOiJlbiIsImlhdCI6MTU2Nzc0MTE1NywiZXhwIjoxNTY3NzQ0NzU3LCJqdGkiOiJkY2MwNjg5NzlkNzM3NGMzODI4MDUyZTk3ZDY2NjU0NTE5MWRhNjY2In0.ZtTGw_EOIg7ApzunkYUBI82V5D6_oAfR83HGQ6NvxZoTfmmnnttRH7a7jHP2YJDNGfpCfY1S9ngEfyZeoQDV1JEg1rp0bV3H5hjr4FZn5ITs0uzpMARpG89RieKddxT9tYqq3zeVZGO8LP_EbtvqJVOB8EwIfPyTeBGG935JG32KZGSmA1f594RHPCHzhZV_y5gYjBi0z5n91x0yt_Kp89koVfo4h8QrDa6zS0UaH56quF872_hsMKihjBEAB4pbMB7AHYGIEWkZBO7HSNXuAhHqTUj2-rH6_IB_M8f2bmyJu19QkRi-IncXnXgLJZp5yMNeD7l_UPtLzVBww9a9aw", false );

		assertTrue ( v.validate ( cred ) );
	}

	@Test
	public void testRsaPem () throws CertificateException, InvalidJwtToken
	{
		final RsaValidator v = new RsaValidator ( "-----BEGIN CERTIFICATE-----\r\n"
				+ "MIIDJjCCAg6gAwIBAgIIXY1WLhGcGjUwDQYJKoZIhvcNAQEFBQAwNjE0MDIGA1UE\r\n"
				+ "AxMrZmVkZXJhdGVkLXNpZ25vbi5zeXN0ZW0uZ3NlcnZpY2VhY2NvdW50LmNvbTAe\r\n"
				+ "Fw0xOTA5MDExNDQ5MzFaFw0xOTA5MTgwMzA0MzFaMDYxNDAyBgNVBAMTK2ZlZGVy\r\n"
				+ "YXRlZC1zaWdub24uc3lzdGVtLmdzZXJ2aWNlYWNjb3VudC5jb20wggEiMA0GCSqG\r\n"
				+ "SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDRBb9+yrxYW00946nxwk7XOhOgH8TYcGzV\r\n"
				+ "jhx4kH/eqAmYBMEJ98bBObvBpgSAiVBsnt+o/W22B1pv7nJBMMasTnX8pLX/eOUH\r\n"
				+ "8QNhk9yJPe7Mejr0ETS/iH0Db18bYxNHWLCSOoO5YT4k3VM1BR5hnnnhZiS1fV3S\r\n"
				+ "qdqI6EzyM0ty5T3jwtb1373HB3s3CcoP89qQI5ZFSpdlVidLsSxMwbhpmlmTRkH7\r\n"
				+ "r3m2wf42bCohI99cjuwSMg1F3Y90P2a+zbEB+n5Pt5oJX4Ld9N+gcMYHdXCR+fWs\r\n"
				+ "ban6EUHnu/NRgHy8R1GBHx6GESBad0tTp+i+9VOhYWc9y+Sb5kXHAgMBAAGjODA2\r\n"
				+ "MAwGA1UdEwEB/wQCMAAwDgYDVR0PAQH/BAQDAgeAMBYGA1UdJQEB/wQMMAoGCCsG\r\n"
				+ "AQUFBwMCMA0GCSqGSIb3DQEBBQUAA4IBAQCvGO1LA+s+1C8ukYrc9Hs7X6d8aCwM\r\n"
				+ "M7uaXR42s/oKlv+7B2EPn6Cyp6UffZ54P41tC8+DhfkszzAcTDt1We2uVjDpmGFc\r\n"
				+ "7GwyfQDQrFFe2lsHh3WEG0jb3v6oGosQC/qq3o+e7bUp51DL0Z6RcDN0KoD9F5bt\r\n"
				+ "eXqJYV378c0txGVm1A2wuhSBPILyesDcpmXGQrHEqfzEcZFzlsemIcJQHhJ7Ciw/\r\n"
				+ "LcRyaSUdUNYWur4ndsGq2zDDt49UN8dsOjMEDxh9DbGwUp+LpkYDcu96Spydkt0D\r\n"
				+ "xSMcjRRMBI9GBKmckFc0TfwfimAqNWDnKQf9S+rQSi2io6bSDlyz3gG3\r\n"
				+ "-----END CERTIFICATE-----" );

		final JwtCredential cred = new JwtCredential ( "eyJhbGciOiJSUzI1NiIsImtpZCI6IjA1YTAyNjQ5YTViNDVjOTBmZGZlNGRhMWViZWZhOWMwNzlhYjU5M2UiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJhY2NvdW50cy5nb29nbGUuY29tIiwiYXpwIjoiMTA4OTEzNzA1NTkxOS1yamlvYjRpZjdscjd2c3R2NGlidjM1YnJ2cWM4dHFuZy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsImF1ZCI6IjEwODkxMzcwNTU5MTktcmppb2I0aWY3bHI3dnN0djRpYnYzNWJydnFjOHRxbmcuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJzdWIiOiIxMDIzNzUwNDQwNzE0NjkwNDkwMDEiLCJoZCI6InJhdGhyYXZhbmUuY29tIiwiZW1haWwiOiJwZXRlckByYXRocmF2YW5lLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJhdF9oYXNoIjoiNlpvSEdyNlVKMDN1X19jMUpfaXg1ZyIsIm5hbWUiOiJQZXRlciBDYXJkb25hIiwicGljdHVyZSI6Imh0dHBzOi8vbGg0Lmdvb2dsZXVzZXJjb250ZW50LmNvbS8tS3RrNjY1cThxRjAvQUFBQUFBQUFBQUkvQUFBQUFBQUFBQUEvQUNIaTNyZVpwVlMzeUs2cTlkWVdBZmhRNFJFNHpCSnFoQS9zOTYtYy9waG90by5qcGciLCJnaXZlbl9uYW1lIjoiUGV0ZXIiLCJmYW1pbHlfbmFtZSI6IkNhcmRvbmEiLCJsb2NhbGUiOiJlbiIsImlhdCI6MTU2Nzc0MTE1NywiZXhwIjoxNTY3NzQ0NzU3LCJqdGkiOiJkY2MwNjg5NzlkNzM3NGMzODI4MDUyZTk3ZDY2NjU0NTE5MWRhNjY2In0.ZtTGw_EOIg7ApzunkYUBI82V5D6_oAfR83HGQ6NvxZoTfmmnnttRH7a7jHP2YJDNGfpCfY1S9ngEfyZeoQDV1JEg1rp0bV3H5hjr4FZn5ITs0uzpMARpG89RieKddxT9tYqq3zeVZGO8LP_EbtvqJVOB8EwIfPyTeBGG935JG32KZGSmA1f594RHPCHzhZV_y5gYjBi0z5n91x0yt_Kp89koVfo4h8QrDa6zS0UaH56quF872_hsMKihjBEAB4pbMB7AHYGIEWkZBO7HSNXuAhHqTUj2-rH6_IB_M8f2bmyJu19QkRi-IncXnXgLJZp5yMNeD7l_UPtLzVBww9a9aw", false );

		assertTrue ( v.validate ( cred ) );
	}
}


/*

PEM for this cert:

-----BEGIN CERTIFICATE-----
MIIDJjCCAg6gAwIBAgIIXY1WLhGcGjUwDQYJKoZIhvcNAQEFBQAwNjE0MDIGA1UE
AxMrZmVkZXJhdGVkLXNpZ25vbi5zeXN0ZW0uZ3NlcnZpY2VhY2NvdW50LmNvbTAe
Fw0xOTA5MDExNDQ5MzFaFw0xOTA5MTgwMzA0MzFaMDYxNDAyBgNVBAMTK2ZlZGVy
YXRlZC1zaWdub24uc3lzdGVtLmdzZXJ2aWNlYWNjb3VudC5jb20wggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDRBb9+yrxYW00946nxwk7XOhOgH8TYcGzV
jhx4kH/eqAmYBMEJ98bBObvBpgSAiVBsnt+o/W22B1pv7nJBMMasTnX8pLX/eOUH
8QNhk9yJPe7Mejr0ETS/iH0Db18bYxNHWLCSOoO5YT4k3VM1BR5hnnnhZiS1fV3S
qdqI6EzyM0ty5T3jwtb1373HB3s3CcoP89qQI5ZFSpdlVidLsSxMwbhpmlmTRkH7
r3m2wf42bCohI99cjuwSMg1F3Y90P2a+zbEB+n5Pt5oJX4Ld9N+gcMYHdXCR+fWs
ban6EUHnu/NRgHy8R1GBHx6GESBad0tTp+i+9VOhYWc9y+Sb5kXHAgMBAAGjODA2
MAwGA1UdEwEB/wQCMAAwDgYDVR0PAQH/BAQDAgeAMBYGA1UdJQEB/wQMMAoGCCsG
AQUFBwMCMA0GCSqGSIb3DQEBBQUAA4IBAQCvGO1LA+s+1C8ukYrc9Hs7X6d8aCwM
M7uaXR42s/oKlv+7B2EPn6Cyp6UffZ54P41tC8+DhfkszzAcTDt1We2uVjDpmGFc
7GwyfQDQrFFe2lsHh3WEG0jb3v6oGosQC/qq3o+e7bUp51DL0Z6RcDN0KoD9F5bt
eXqJYV378c0txGVm1A2wuhSBPILyesDcpmXGQrHEqfzEcZFzlsemIcJQHhJ7Ciw/
LcRyaSUdUNYWur4ndsGq2zDDt49UN8dsOjMEDxh9DbGwUp+LpkYDcu96Spydkt0D
xSMcjRRMBI9GBKmckFc0TfwfimAqNWDnKQf9S+rQSi2io6bSDlyz3gG3
-----END CERTIFICATE-----

modulus from key read by java built-in code:
26386640196372426380437575256004548936078072361252547077903440302506233434026751142864687086939606473921399288790210323600409676795193267305585389059810176539488639444390947099699907424596002414905393427842778094187859764992449565396383471129542818197816195695120715225228023515249902749246068703546189510800383607006572535126780003955237938919642024842060843141184329176556409221492538479319048970969157596490567720452340615746813764533701900891564417052816935374290624864997316451761737845169579480665181743826245198966407270954746461442427988790235075562783746664947912733632469577829222861610766205251772685370823

modulus from key read by my stringToInt fn:
26386640196372426380437575256004548936078072361252547077903440302506233434026751142864687086939606473921399288790210323600409676795193267305585389059810176539488639444390947099699907424596002414905393427842778094187859764992449565396383471129542818197816195695120715225228023515249902749246068703546189510800383607006572535126780003955237938919642024842060843141184329176556409221492538479319048970969157596490567720452340615746813764533701900891564417052816935374290624864997316451761737845169579480665181743826245198966407270954746461442427988790235075562783746664947912733632469577829222861610766205251772685370823


dump from openssl:

        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d1:05:bf:7e:ca:bc:58:5b:4d:3d:e3:a9:f1:c2:
                    4e:d7:3a:13:a0:1f:c4:d8:70:6c:d5:8e:1c:78:90:
                    7f:de:a8:09:98:04:c1:09:f7:c6:c1:39:bb:c1:a6:
                    04:80:89:50:6c:9e:df:a8:fd:6d:b6:07:5a:6f:ee:
                    72:41:30:c6:ac:4e:75:fc:a4:b5:ff:78:e5:07:f1:
                    03:61:93:dc:89:3d:ee:cc:7a:3a:f4:11:34:bf:88:
                    7d:03:6f:5f:1b:63:13:47:58:b0:92:3a:83:b9:61:
                    3e:24:dd:53:35:05:1e:61:9e:79:e1:66:24:b5:7d:
                    5d:d2:a9:da:88:e8:4c:f2:33:4b:72:e5:3d:e3:c2:
                    d6:f5:df:bd:c7:07:7b:37:09:ca:0f:f3:da:90:23:
                    96:45:4a:97:65:56:27:4b:b1:2c:4c:c1:b8:69:9a:
                    59:93:46:41:fb:af:79:b6:c1:fe:36:6c:2a:21:23:
                    df:5c:8e:ec:12:32:0d:45:dd:8f:74:3f:66:be:cd:
                    b1:01:fa:7e:4f:b7:9a:09:5f:82:dd:f4:df:a0:70:
                    c6:07:75:70:91:f9:f5:ac:6d:a9:fa:11:41:e7:bb:
                    f3:51:80:7c:bc:47:51:81:1f:1e:86:11:20:5a:77:
                    4b:53:a7:e8:be:f5:53:a1:61:67:3d:cb:e4:9b:e6:
                    45:c7
                Exponent: 65537 (0x10001)

*/